/*
name: nks-file-manager
version: 0.0.1
author: Konstantin Nizhinskiy <konstantin.nizhinskiy@gmail.com>
date: 2016-01-13 17:01:03 

*/
define("FileManagerConfig",[],function(){var e={host:"/fm",maxFileSize:1048576,locale:"ru",typeViewContent:"menu"},n=function(){"undefined"!=typeof localStorage&&(e.typeViewContent=localStorage.getItem("fm-typeViewContent")||"menu")};return n.prototype.init=function(n){"undefined"!=typeof n.host&&(e.host=n.host),"undefined"!=typeof n.maxFileSize&&(e.maxFileSize=n.maxFileSize),"undefined"!=typeof n.locale&&(e.locale=n.locale)},n.prototype.getHost=function(){return e.host},n.prototype.getMaxFileSize=function(){return e.maxFileSize},n.prototype.getLocale=function(){return e.locale},n.prototype.getTypeViewContent=function(){return e.typeViewContent},n.prototype.setTypeViewContent=function(n){e.typeViewContent=n,"undefined"!=typeof localStorage&&localStorage.setItem("fm-typeViewContent",n)},new n}),define("build/JST.FileManagerBundle",[],function(){return this.WC=this.WC||{},this.WC.JSTFileManager=this.WC.JSTFileManager||{},this.WC.JSTFileManager.FileManagerContentView=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="fm-panel">\n<span class="fm-panel-btn"><a class="folder-view icon-picture active"> '+(null==(__t=fmTrans.get("folder.view"))?"":__t)+'</a></span>\n<span class="fm-panel-btn"><a class="create-folder icon-folder-open"> '+(null==(__t=fmTrans.get("create.folder"))?"":__t)+'</a></span>\n<span class="fm-panel-btn"><a class="load-file icon-download"> '+(null==(__t=fmTrans.get("load.file"))?"":__t)+'</a></span>\n<span class="fm-panel-btn"><a class="select-remove icon-trash-empty"> '+(null==(__t=fmTrans.get("remove"))?"":__t)+'</a></span>\n<span class="fm-panel-btn fm-panel-btn-right"><a class="view-th icon-menu"></a></span>\n<span class="fm-panel-btn fm-panel-btn-right"><a class="view-menu icon-th"></a></span>\n</div>\n<div data-content=""></div>';return __p},this.WC.JSTFileManager.FileManagerCreateFolderView=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="fm-create-folder">\n<input type="text" class="fm-name-folder fm-input">\n<a type="text" class="fm-folder-save fm-btn">'+(null==(__t=fmTrans.get("create"))?"":__t)+"</a>\n</div>";return __p},this.WC.JSTFileManager.FileManagerLoadFileView=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<form>\n<div class="fm-drop-zone">\n<div>'+(null==(__t=fmTrans.get("drag.file.here"))?"":__t)+"</div>\n<div>"+(null==(__t=fmTrans.get("or"))?"":__t)+'</div>\n<div class="fm-drop-zone-message">\n<div><input type="file"></div></div>\n</form>';return __p},this.WC.JSTFileManager.FileManagerUserFileView=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)"menu"==typeViewContent?(__p+='\n<div class="fm-user-file">',__p+=1==isDir?'\n<div class="fm-check-file fm-user-file-content fm-user-folder-content icon-folder-open"></div>\n':'\n<div class="fm-check-file fm-user-file-content fm-user-folder-content">\n<img src="'+(null==(__t=link)?"":__t)+'">\n</div>\n',__p+='\n<div class=" fm-user-file-name">\n'+(null==(__t=name)?"":__t)+"\n",__p+=0==fileCheck?'\n<div class="fm-user-file-check icon-check-empty" style="display: none;"></div>\n':'\n<div class="fm-user-file-check icon-check"></div>\n',__p+="\n</div>\n</div>\n"):(__p+='\n<td style="width: 20px;">',__p+=0==fileCheck?'\n<span class="fm-user-file-check icon-check-empty"></span>\n':'\n<span class="fm-user-file-check icon-check"></span>\n',__p+="\n</td>\n<td>\n",__p+=1==isDir?'\n<div class="fm-check-file fm-user-file-content fm-user-folder-content icon-folder-open">'+(null==(__t=name)?"":__t)+"</div>\n":'\n<div class="fm-check-file icon-picture">'+(null==(__t=name)?"":__t)+"</div>\n",__p+="\n</td>\n<td>"+(null==(__t=1==isDir?"":typeFile)?"":__t)+"</td>\n<td>"+(null==(__t=1==isDir?"":fileSize)?"":__t)+"</td>\n<td>"+(null==(__t=dateLoad)?"":__t)+"</td>\n");return __p},this.WC.JSTFileManager.FileManagerUserListView=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)__p+='<div class="fm-namespace">'+(null==(__t=lastNamespace)?"":__t)+"</div>","menu"==typeViewContent?(__p+='\n<div class="fm-type-view-menu">\n',"/"!=lastNamespace&&(__p+='<div class="fm-back-folder fm-user-file">\n<div class="fm-user-file-content fm-user-folder-content icon-folder-open"></div>\n<div class="fm-user-file-name">\n<b>. . .</b>\n</div>\n</div>\n'),__p+='\n<div class="fm-user-files "></div>\n</div>\n'):(__p+='\n<div class="fm-type-view-th">\n<table>\n<thead>\n<tr>\n<td></td>\n<td>'+(null==(__t=fmTrans.get("file.name"))?"":__t)+"</td>\n<td>"+(null==(__t=fmTrans.get("file.type"))?"":__t)+"</td>\n<td>"+(null==(__t=fmTrans.get("file.size"))?"":__t)+"</td>\n<td>"+(null==(__t=fmTrans.get("file.create"))?"":__t)+"</td>\n</tr>\n","/"!=lastNamespace&&(__p+='\n<tr>\n<td></td>\n<td class="fm-back-folder"><div class="fm-user-file-content fm-user-folder-content icon-folder-open"><span class="fm-user-file-name"><b>. . .</b></span></div></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n'),__p+='\n</thead><tbody class="fm-user-files"></tbody></table>\n</div>\n');return __p},this.WC.JSTFileManager.FileManagerHeaderView=function(obj){obj||(obj={});var __p="";_.escape,Array.prototype.join;with(obj)__p+='<div class="fm-header">\n<div class="fm-header-title">FileManager</div>\n',close===!0&&(__p+='\n<div class="fm-header-cancel icon-cancel"></div>\n'),__p+="\n</div>";return __p},this.WC.JSTFileManager.FileManagerLayoutModalView=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="fm-modal-in"></div>\n<div class="fm-modal-contents">\n<div class="FileManagerLayout-header-modal"></div>\n<div class="FileManagerLayout-content-modal"></div>\n<div class="FileManagerLayout-footer-modal"></div>\n</div>';return __p},this.WC.JSTFileManager.FileManagerLayoutView=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="FileManagerLayout-header"></div>\n<div class="FileManagerLayout-nav"></div>\n<div class="FileManagerLayout-content"></div>\n<div class="FileManagerLayout-footer"></div>';return __p},this.WC.JSTFileManager.FileManagerNavView=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<ul class="nav nav-pills nav-stacked">\n<li role="presentation" class="active"><a class="icon-folder-open"> '+(null==(__t=fmTrans.get("root"))?"":__t)+"</a></li>\n</ul>";return __p},this.WC.JSTFileManager}),define("translations/en",[],function(){return{root:"Root"}}),define("translations/ru",[],function(){return{root:"Root","create.folder":"Создать каталог","load.file":"Загрузить файл",remove:"Удалить файл","drag.file.here":"Перетащите файл сюда",or:"или","the.file.is.too.large":"Файл слишком большой",load:"Загрузка","folder.view":"Просмотр каталога"}}),define("translations/ua",[],function(){return{}}),define("translations/fmTrans",["FileManagerConfig","translations/en","translations/ru","translations/ua"],function(e,n,t,i){var a=function(){this.ua=i,this.ru=t,this.en=n};return a.prototype.get=function(n){var t=e.getLocale();return this[t]&&this[t][n]?this[t][n]:n},new a}),define("views/nav/FileManagerNavView",["marionette","build/JST.FileManagerBundle","translations/fmTrans"],function(e,n,t){return e.ItemView.extend({template:n.FileManagerNavView,templateHelpers:function(){return{fmTrans:t}}})}),define("views/header/FileManagerHeaderView",["marionette","build/JST.FileManagerBundle","translations/fmTrans"],function(e,n,t){return e.ItemView.extend({_close:!1,initialize:function(e){"undefined"!=typeof e.close&&(this._close=e.close)},ui:{fmHeaderCancel:".fm-header-cancel"},events:{"click @ui.fmHeaderCancel":"fmHeaderCancel"},fmHeaderCancel:function(){this.trigger("fmHeaderCancel")},template:n.FileManagerHeaderView,templateHelpers:function(){return{fmTrans:t,close:this._close}}})}),define("views/content/FileManagerLoadFileView",["marionette","build/JST.FileManagerBundle","FileManagerConfig","translations/fmTrans"],function(e,n,t,i){return e.ItemView.extend({initialize:function(e){this.lastNamespace=e.lastNamespace||"/"},ui:{dropZone:".fm-drop-zone",dropZoneMessage:".fm-drop-zone-message",fileInput:"input[type=file]"},events:{"click @ui.dropZone":"dropZone","change @ui.fileInput":"loadChangeFile"},loadChangeFile:function(e){this.loadFile(e.target.files[0])},loadFile:function(e){if(e.size>t.getMaxFileSize())return this.ui.dropZoneMessage.html(i.get("the.file.is.too.large")),this.ui.dropZone.addClass("error"),!1;var n=new FormData,a=new XMLHttpRequest;a.upload.addEventListener("progress",this.uploadProgress.bind(this),!1),a.onreadystatechange=this.stateChange.bind(this),a.open("POST",t.getHost()+"/api/loadFile/"),n.append("file",e),n.append("namespace",this.lastNamespace),a.send(n)},dropZoneStart:function(){var e=this,n=this.ui.dropZone;n[0].ondragover=function(){return n.addClass("hover"),!1},n[0].ondragleave=function(){return n.removeClass("hover"),!1},n[0].ondrop=function(t){t.preventDefault(),n.removeClass("hover"),n.addClass("drop");var i=t.dataTransfer.files[0];e.loadFile(i)}},uploadProgress:function(e){var n=parseInt(e.loaded/e.total*100);this.ui.dropZone.html(i.get("load")+": "+n+"%")},stateChange:function(e){4==e.target.readyState&&this.trigger("folderView")},onRender:function(){this.dropZoneStart()},template:n.FileManagerLoadFileView,templateHelpers:function(){return{fmTrans:i}}})}),define("views/content/FileManagerUserFileView",["marionette","build/JST.FileManagerBundle","FileManagerConfig","translations/fmTrans"],function(e,n,t,i){return e.ItemView.extend({initialize:function(){},ui:{fmUserFileContent:".fm-user-file-content",fmUserFile:".fm-user-file",fmUserFileCheck:".fm-user-file-check"},events:{"click @ui.fmUserFileContent":"fmUserFileContent","mouseenter @ui.fmUserFile":"mouseOn","mouseleave @ui.fmUserFile":"mouseOff","click @ui.fmUserFileCheck":"fmUserFileCheck"},mouseOn:function(){this.ui.fmUserFileCheck.show()},mouseOff:function(){0==this.model.get("fileCheck")&&this.ui.fmUserFileCheck.hide()},fmUserFileContent:function(){this.model.trigger("selectContent",this.model)},fmUserFileCheck:function(){var e=this.model.get("fileCheck")||!1;this.model.set("fileCheck",!e),this.render()},template:n.FileManagerUserFileView,templateHelpers:function(){var e=this.model.get("fileSize"),n=this.model.get("dateLoad");return e!==!1&&(e>1024?e=(e/1024).toFixed(2)+" Kb":e+=" B"),10===n.toString().length&&(n=n.toString()+"000",n=new Date(parseFloat(n)),n=n.toString()),{fmTrans:i,typeViewContent:t.getTypeViewContent(),dateLoad:n,fileSize:e}}})}),define("views/content/FileManagerUserListView",["marionette","build/JST.FileManagerBundle","FileManagerConfig","translations/fmTrans","views/content/FileManagerUserFileView"],function(e,n,t,i,a){return e.CompositeView.extend({initialize:function(){this.collection.fetch({})},ui:{fmBackFolder:".fm-back-folder",fmNamespace:".fm-namespace"},events:{"click @ui.fmBackFolder":"fmBackFolder"},collectionEvents:{selectContent:"selectContent"},filter:function(e,n,t){return e.get("namespace")===this.collection.lastNamespace},onBeforeDestroy:function(){this.collection.off("selectContent")},childViewContainer:".fm-user-files",childView:a,childViewOptions:function(){return{tagName:"th"===t.getTypeViewContent()?"tr":"div"}},fmBackFolder:function(){var e,n="";"/"!=this.collection.lastNamespace&&(e=this.collection.lastNamespace.split("/"),e.splice(e.length-2,2),n=e.join("/"),this.collection.lastNamespace=n+"/",this.render())},selectContent:function(e){e.get("isDir")===!0?(this.collection.lastNamespace=e.get("namespace")+e.get("name")+"/",this.render()):this.trigger("selectFile",e.toJSON())},onRender:function(){},template:n.FileManagerUserListView,templateHelpers:function(){var e=this.collection.lastNamespace;return"/"!=this.collection.lastNamespace&&(e=e.split("/"),e.pop(),e.shift(),e=e.join(" / ")),{fmTrans:i,lastNamespace:e,typeViewContent:t.getTypeViewContent()}}})}),define("views/content/FileManagerCreateFolderView",["marionette","build/JST.FileManagerBundle","FileManagerConfig","translations/fmTrans"],function(e,n,t,i){return e.ItemView.extend({initialize:function(e){this.lastNamespace=e.lastNamespace||"/"},ui:{fmNameFolder:".fm-name-folder",save:".fm-folder-save"},events:{"click @ui.save":"save"},save:function(){var e=this;this.model.save({lastNamespace:this.lastNamespace,namespace:this.ui.fmNameFolder.val()},{success:function(){e.trigger("folderView")}})},template:n.FileManagerCreateFolderView,templateHelpers:function(){return{fmTrans:i}}})}),define("models/FileManagerUserFileModel",["backbone","underscore","FileManagerConfig"],function(e,n,t){return e.Model.extend({urlRoot:function(){return t.getHost()+"/api/userFile/"},defaults:{fileCheck:!1}})}),define("collections/FileManagerUserFileCollection",["backbone","underscore","FileManagerConfig","models/FileManagerUserFileModel"],function(e,n,t,i){return e.Collection.extend({url:function(){return t.getHost()+"/api/userFile/"},model:i,lastNamespace:"/",comparator:function(e){return!e.get("isDir")},getFolder:function(e){this.collection.where({namespace:e})}})}),define("models/CreateFolderModel",["backbone","FileManagerConfig"],function(e,n){return e.Model.extend({url:function(){return n.getHost()+"/api/createFolder/"}})}),define("views/content/FileManagerContentView",["marionette","build/JST.FileManagerBundle","views/content/FileManagerLoadFileView","views/content/FileManagerUserListView","views/content/FileManagerCreateFolderView","translations/fmTrans","collections/FileManagerUserFileCollection","models/CreateFolderModel","FileManagerConfig"],function(e,n,t,i,a,l,o,r,s){return e.ItemView.extend({initialize:function(){},ui:{fmPanelBtn:".fm-panel-btn",createFolder:".create-folder",folderView:".folder-view",loadFile:".load-file",selectRemove:".select-remove",viewTh:".view-th",viewMenu:".view-menu",content:"[data-content]"},events:{"click @ui.createFolder":"createFolder","click @ui.folderView":"folderView","click @ui.loadFile":"loadFile","click @ui.selectRemove":"selectRemove","click @ui.viewTh":"viewTh","click @ui.viewMenu":"viewMenu"},folderView:function(){var e="/";this.fileManagerUserFileCollection&&(e=this.fileManagerUserFileCollection.lastNamespace),this.fileManagerUserFileCollection=new o,this.fileManagerUserFileCollection.lastNamespace=e,this.fileManagerUserFileCollection.off("change:fileCheck"),this.fileManagerUserFileCollection.on("change:fileCheck",this.fileCheck.bind(this)),this.ui.fmPanelBtn.find("a").removeClass("active"),this.ui.folderView.addClass("active");var n=new i({collection:this.fileManagerUserFileCollection});n.on("selectFile",this.trigger.bind(this,"selectFile")),this.ui.content.html(n.render().el),this.fileCheck()},createFolder:function(){this.ui.fmPanelBtn.find("a").removeClass("active"),this.ui.createFolder.addClass("active");var e=new a({lastNamespace:this.fileManagerUserFileCollection.lastNamespace||"",model:new r});this.ui.content.html(e.render().el),e.once("folderView",this.folderView.bind(this))},loadFile:function(){this.ui.fmPanelBtn.find("a").removeClass("active"),this.ui.loadFile.addClass("active");var e=new t({lastNamespace:this.fileManagerUserFileCollection.lastNamespace||""});this.ui.content.html(e.render().el),e.once("folderView",this.folderView.bind(this))},selectRemove:function(){var e=this;_.each(this.fileManagerUserFileCollection.where({fileCheck:!0}),function(n){n.destroy({success:function(){e.fileCheck()}})})},viewTh:function(){s.setTypeViewContent("th"),this.render()},viewMenu:function(){s.setTypeViewContent("menu"),this.render()},fileCheck:function(){this.fileManagerUserFileCollection.where({fileCheck:!0}).length>0?this.ui.selectRemove.show():this.ui.selectRemove.hide()},onRender:function(){this.folderView(),this.fileCheck()},template:n.FileManagerContentView,templateHelpers:function(){return{fmTrans:l}}})}),define("views/layout/FileManagerLayoutView",["marionette","build/JST.FileManagerBundle","views/nav/FileManagerNavView","views/header/FileManagerHeaderView","views/content/FileManagerContentView"],function(e,n,t,i,a){return e.LayoutView.extend({_header:!0,initialize:function(e){"undefined"!=typeof e.header&&(this._header=e.header)},template:n.FileManagerLayoutView,regions:{header:".FileManagerLayout-header",nav:".FileManagerLayout-nav",content:".FileManagerLayout-content",footer:".FileManagerLayout-footer"},onRender:function(){var e=new t,n=new i,l=new a;this.nav.show(e),this._header===!0&&this.header.show(n),l.on("selectFile",this.trigger.bind(this,"selectFile")),this.content.show(l)}})}),define("views/layout/FileManagerLayoutModalView",["marionette","build/JST.FileManagerBundle","views/layout/FileManagerLayoutView","views/header/FileManagerHeaderView"],function(e,n,t,i){return e.LayoutView.extend({className:"fm-modal",initialize:function(){},template:n.FileManagerLayoutModalView,regions:{header:".FileManagerLayout-header-modal",content:".FileManagerLayout-content-modal",footer:".FileManagerLayout-footer-modal"},onRender:function(){var e=new t({header:!1}),n=new i({close:!0});n.once("fmHeaderCancel",this.remove.bind(this)),this.content.show(e),e.on("selectFile",this.trigger.bind(this,"selectFile")),this.header.show(n)}})}),define("FileManager",["jquery","FileManagerConfig","views/layout/FileManagerLayoutView","views/layout/FileManagerLayoutModalView"],function(e,n,t,i){var a=function(){};return a.prototype.init=function(e){n.init(e)},a.prototype.getFileManager=function(){return new t},a.prototype.openFileManager=function(){var n=this,t=new i;e("body").append(t.render().el),t.on("selectFile",function(e){n.trigger("selectFile",e),t.remove()})},_.extend(new a,Backbone.Events)});